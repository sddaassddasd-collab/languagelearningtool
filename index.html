<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>本地英文點字查詢＋生字本（Sheet／AI 生成／解析／TTS）</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --fg:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --danger:#ef4444; --blue:#38bdf8; --green:#22c55e;
    --border:rgba(255,255,255,.08); --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:16px;min-height:100vh}
  header{position:sticky;top:0;z-index:5;background:rgba(15,23,42,.9);backdrop-filter:blur(8px);
    border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  .main{max-width:1200px;margin:0 auto;width:100%;padding:16px}
  .editor, .reader, .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
  .editor{padding:14px}
  textarea{
    width:100%;min-height:180px;background:#0b1220;color:var(--fg);border:1px solid var(--border);
    border-radius:12px;padding:12px;font-size:15px;line-height:1.6;resize:vertical;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{
    background:var(--accent);color:#07210f;border:none;border-radius:999px;padding:10px 14px;font-weight:600;
    cursor:pointer;transition:transform .05s ease;box-shadow:0 6px 20px rgba(34,197,94,.25)
  }
  button.secondary{background:#1f2937;color:var(--fg);box-shadow:none;border:1px solid var(--border)}
  button.ghost{background:transparent;color:var(--muted);border:1px dashed var(--border);box-shadow:none}
  button.danger{background:var(--danger);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  button:active{transform:translateY(1px)}

  .reader{
    padding:16px;line-height:1.8;min-height:240px;white-space:pre-wrap;
  }
  .reader .word{
    cursor:pointer;
    padding:1px 2px;
    border-radius:6px;
    transition:background .15s, outline-color .15s, transform .08s ease;
    /* 讓 ::after 外環能正確定位，並避免被行內排版吃掉 */
    position:relative;
    display:inline-block;
    outline-offset:2px;  /* 讓藍/綠框與實際內容有距離，不互相蓋住 */
  }
  .reader .word:hover{ background:rgba(255,255,255,.06) }

  /* 外環擴散（在藍/綠框之上，仍清楚可見） */
  .reader .word.clicked::after{
    content:"";
    position:absolute;
    inset:-4px;                 /* 外環比字大一點點 */
    border-radius:8px;
    pointer-events:none;
    box-shadow: 0 0 0 0 rgba(56,189,248,.65);
    animation: ringPulse .55s ease-out forwards;
    z-index:1;                  /* 蓋在 outline 之上，但不遮文字 */
  }

  /* 輕微彈跳（確保視覺上「有按到」） */
  .reader .word.clicked{
    transform: scale(1.06);
    animation: popBack .55s ease-out;
  }

  @keyframes ringPulse{
    0%   { box-shadow: 0 0 0 0 rgba(56,189,248,.65); opacity:1; }
    60%  { box-shadow: 0 0 0 10px rgba(56,189,248,.20); opacity:1; }
    100% { box-shadow: 0 0 0 14px rgba(56,189,248,0);  opacity:0; }
  }
  @keyframes popBack{
    0%   { transform: scale(1.06) }
    100% { transform: scale(1.00) }
  }


  .reader{ padding-bottom: 72px; } 

  /* 段落容器與左側播放鈕（生成語音後才插入 .playseg） */
  .seg{position:relative; padding-left:20px; margin:4px 0;}
  .seg.empty{padding-left:0;}
  .seg .playseg{
    position:absolute; left:0; top:0.1em; border:1px solid var(--border);
    background:#0b1220; color:#cbd5e1; border-radius:8px; padding:2px 6px;
    font-size:12px; cursor:pointer; box-shadow:none; display:inline-block;
  }
  .seg .playseg:hover{background:#1f2937}
  .seg.sep{ padding-left:0; margin:6px 0; height:6px; }
/* 目前播放中的段落醒目提示（不覆蓋單字內的框線） */
.seg.playing{
  outline:2px solid rgba(56,189,248,.6);      /* 藍色外框 */
  background:linear-gradient(
    to right,
    rgba(56,189,248,.10),
    rgba(56,189,248,.04)
  );
  border-radius:12px;
  transition:background .2s ease, outline-color .2s ease;
}


  /* 高頻：前 15 → 藍框；16–50 → 綠框 */
  .reader .hf15{outline:2px solid var(--blue); background:rgba(56,189,248,.10)}
  .reader .hf50{outline:1px dashed var(--green); background:rgba(34,197,94,.08)}
  /* 雙擊扣分後的紅框（本次生成內的所有相同字都會紅） */
  .reader .deducted{outline:2px solid var(--danger) !important; background:rgba(239,68,68,.10) !important}

  .help{color:var(--muted);font-size:13px;margin-top:8px}

  .sidebar{padding:12px;display:flex;flex-direction:column;max-height:calc(100vh - 120px)}
  .side-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .list{flex:1;overflow:auto;border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
  .item{
    display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;
    padding:8px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;background:#0b1220
  }
  .item .w{font-weight:700}
  .item .c{color:var(--muted);font-variant-numeric:tabular-nums}
  .item .t{color:var(--muted);font-size:12px}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .search{display:flex;gap:6px;margin-top:6px}
  .search input, .kblock input, .kblock select{
    flex:1;background:#0b1220;border:1px solid var(--border);border-radius:12px;color:var(--fg);padding:10px 12px
  }

  /* 單字解釋卡（右下） */
  .card{
    position:fixed;right:20px;bottom:20px;z-index:50;max-width:520px;
    background:#111827;border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4)
  }
  .card header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .card .content{padding:12px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);color:#94a3b8;font-size:12px;margin-right:6px}
  .phon{color:#94a3b8;margin-left:6px}
  .defs{margin:8px 0 0 0;padding-left:18px}
  .defs li{margin:6px 0}
  .note-row{display:flex;gap:6px;margin-top:10px}
  .note-row input{flex:1;background:#0b1220;border:1px solid var(--border);border-radius:10px;color:#e5e7eb;padding:8px 10px}
  .empty{color:#94a3b8;text-align:center;padding:24px}
  .kblock{display:flex;flex-direction:column;gap:10px;margin-top:8px}

  /* 句子解析卡：固定底部置中，可滾動 */
  .analysis{
    position:fixed; left:50%; bottom:64px; transform:translateX(-50%);
    z-index:55; max-width:880px; width:calc(100% - 32px);
    background:#111827; border:1px solid var(--border); border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,.5); display:none;
  }
  .analysis header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .analysis .content{padding:12px; max-height:52vh; overflow:auto;}
  .analysis .sec{margin:10px 0}
  .analysis .sec h4{margin:0 0 6px 0; color:#93c5fd; font-size:14px}
  .analysis .quote{color:#cbd5e1; background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:10px; white-space:pre-wrap}
  .analysis .zh{white-space:pre-wrap; line-height:1.7}
  .analysis .list{margin:0; padding-left:18px}
  .analysis .list li{margin:6px 0}
  .analysis .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .chip{display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#cbd5e1; background:#0b1220}
  /* 讓「其他例句」段落底下更寬鬆 */
  .analysis .sec.examples{margin-bottom: 64px;  /* 想更寬可以調大，例如 80px/96px */}

  /* 底部工具列：翻譯與文法（只有選取後才顯示） */
  .bottom-bar{
    position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
    z-index:60; display:none; gap:8px; align-items:center;
    background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:8px 10px;
    box-shadow:0 10px 40px rgba(0,0,0,.45)
  }
  .bottom-bar .status{font-size:12px; color:#94a3b8; padding:0 8px}

  /* 左側收合抽屜（hover 最左邊滑出） */
  .tts-drawer{
  position:fixed; top:20%; left:-260px; width:260px;
  background:#0b1220; border:1px solid var(--border); border-left:none;
  border-radius:0 12px 12px 0; box-shadow:0 10px 40px rgba(0,0,0,.5);
  transition:left .25s ease; z-index:70; padding:12px; display:none;
  }
  .tts-drawer.show{display:block;}
  .tts-drawer:hover, .tts-drawer:focus-within{ left:0; }
  .tts-drawer .handle{
  position:absolute; right:-24px; top:0; bottom:0; width:24px;
  background:#0b1220; border:1px solid var(--border); border-left:none;
  border-radius:0 12px 12px 0; display:flex; align-items:center; justify-content:center;
  cursor:ew-resize; color:#94a3b8; font-size:12px;
  }
  .tts-drawer .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .tts-drawer input[type="range"]{width:150px}

  @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
    .sidebar{height:auto;max-height:none}
    .card{left:12px; right:12px; bottom:12px; max-width:none}
    .analysis{left:50%; right:auto; transform:translateX(-50%); max-width:none}
  }
/* 句型解析：內容區預留底部空間給固定問答區 */
.analysis .content{
  padding: 12px;
  max-height: calc(52vh - 84px); /* 52vh 扣掉底部問答區的高度 */
  overflow: auto;
  margin-bottom: 84px;           /* 再保險預留空間避免被蓋到 */
}

/* 問題區：固定在卡片內底部（佔滿寬） */
#analysisCard{ position:fixed; } /* 已有，保險再聲明一下 */
#extraQ{
  position: absolute;
  left: 0; right: 0; bottom: 0;
  z-index: 1;
  background:#111827;
  border-top:1px solid var(--border);
  padding:10px 12px;
  border-radius: 0 0 16px 16px;  /* 與卡片圓角一致 */
}
#extraQ input{
  width: 100%;
  max-width: none;
}


</style>
</head>
<body>
<header>
  <div class="wrap">
    <strong>本地英文點字查詢＋生字本</strong>
  </div>
</header>

<main class="main">
  <div class="layout">
    <section>
      <div class="editor">
        <label for="src" style="display:block;margin:0 0 8px 2px;color:var(--muted);font-size:13px">在下方貼上英文文章：</label>
        <textarea id="src" placeholder="Paste your English article here..."></textarea>
        <div class="row">
         <button id="compile">產生可點文字</button>
         <button id="sample" class="secondary">貼入範例</button>
          <button id="clearAll" class="ghost">清空文章</button>
         <button id="buildTTS" class="secondary">生成語音</button>
          <select id="voicePref" style="min-width:96px">
           <option value="male" selected>男</option>
           <option value="female">女</option>
          </select>
        </div>
        <div class="help">雙擊某字可扣 2，並讓該次生成的所有相同字變紅；重新產生會恢復。前 15 藍框、16–50 綠框。段落喇叭在「生成語音」後才出現。</div>
      </div>

      <div style="height:12px"></div>

      <div id="reader" class="reader" aria-live="polite">
        <div class="empty">尚未產生內容。請先貼上文章並點「產生可點文字」。</div>
      </div>
    </section>

    <aside class="sidebar">
      <div class="side-head">
        <div>
          <div style="font-weight:700">生字本</div>
          <div class="help">（儲存於本機 localStorage；有解釋才背景傳送到 Google Sheet）</div>
        </div>
        <div class="tools">
          <button id="exportCSV" class="secondary">匯出 CSV</button>
          <button id="exportJSON" class="secondary">匯出 JSON</button>
          <label class="secondary" style="padding:10px 12px;border-radius:999px;cursor:pointer">
            匯入 JSON
            <input id="importJSON" type="file" accept="application/json" style="display:none">
          </label>
           <!-- ★ 新增：匯入 CSV -->

          <label class="secondary" style="padding:10px 12px;border-radius:999px;cursor:pointer">
            匯入 CSV
            <input id="importCSV" type="file" accept=".csv,text/csv" style="display:none">
          </label>

          <button id="resetWords" class="danger">清空生字本</button>
          <button id="toggleDict" class="secondary" title="點一下關閉字典卡">字典：開</button>
        </div>

        <!-- 生成內容（前端直呼 OpenAI） -->
        <div class="kblock">
          <input id="openaiKey" type="password" placeholder="OpenAI API Key（僅存本機）">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
  <label class="help" for="providerSelect">提供者：</label>
  <select id="providerSelect">
    <option value="openai" selected>OpenAI</option>
    <option value="grok">Grok (xAI)</option>
  </select>

  <label class="help" for="modelSelect">模型：</label>
  <select id="modelSelect" style="min-width:220px">
    <!-- 會由 JS 依提供者填入預設清單；也支援自由輸入 -->
  </select>

  <!-- 允許自由輸入模型名 -->
  <input id="modelCustom" placeholder="或自行輸入模型名稱…" style="flex:1;min-width:200px">
</div>

<!-- Grok API Key（預設隱藏；選擇 Grok 時顯示） -->
<input id="grokKey" type="password" placeholder="Grok API Key（僅存本機）" style="display:none;margin-top:8px">

          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <label class="help" for="levelSelect">程度：</label>
            <select id="levelSelect">
              <option value="A1">A1</option><option value="A2">A2</option>
              <option value="B1" selected>B1</option><option value="B2">B2</option>
              <option value="C1">C1</option><option value="C2">C2</option>
            </select>
            <label class="help" for="langSelect">語言：</label>
            <select id="langSelect">
              <option value="en" selected>英語</option>
              <option value="de">德語</option>
            </select>

          <label class="help" for="genreSelect">類型：</label>
          <select id="genreSelect">
            <option value="fairy_tale" selected>童話故事</option>
            <option value="dialogue">日常對話</option>
            <option value="article">隨機領域專業文章</option>
            <option value="mature_18">18＋</option>
            <option value="custom">自訂主題</option>
          </select>
            <input id="customTopic"
       placeholder="輸入想要生成的主題／風格（例如：關於可再生能源的說服文）"
              style="flex:1;display:none">

         <label class="help" for="lengthInput">字數：</label>
  <input id="lengthInput" type="number" min="100" max="1200" step="50" value="500" style="width:110px">


            <button id="saveKey" class="secondary">儲存金鑰（本機）</button>
            <button id="genContent">生成內容</button>
          </div>
            <div class="help">有生字本→取點擊最多的前 15；無單字→隨機生成。字數可在右側調整。</div>
        </div>

      </div>

      <div class="search">
        <input id="q" placeholder="搜尋生字或備註..." />
        <button id="qClear" class="secondary">清除</button>
      </div>

      <div id="wordList" class="list"></div>
    </aside>
  </div>
</main>

<!-- 單字解釋卡 -->
<div id="card" class="card" style="display:none">
  <header>
    <div id="cardTitle"><span class="badge">查詢</span></div>
    <button id="cardClose" class="secondary">關閉</button>
  </header>
  <div class="content">
    <div id="cardMeta" class="help"></div>
    <ol id="defs" class="defs"></ol>
    <div class="note-row">
      <input id="noteInput" placeholder="加個備註（例：考點、例句、同義字）">
      <button id="saveNote" class="secondary">儲存備註</button>
    </div>
    <div id="offlineTip" class="help" style="display:none;margin-top:8px">
      無法連線字典或查無資料；你可手動輸入備註作為臨時解釋。
    </div>
  <!-- 單字卡：額外提問（針對此單字） -->
<div class="note-row">
  <input id="wordQInput" placeholder="有什麼想問的（針對此單字）">
  <button id="wordQBtn" class="secondary">送出問題</button>
</div>
<div id="qaBox" class="help" style="margin-top:8px;color:#a1a1aa"></div>


  </div>
</div>

<!-- 句子解析卡（固定底部置中，可滾動） -->
<div id="analysisCard" class="analysis">
  <header>
    <div><span class="badge">解析</span> <strong>句子解析</strong></div>
    <div class="actions">
      <span id="selPreview" class="chip">未選取</span>
      <button id="analysisClose" class="secondary">關閉</button>
    </div>
  </header>
  <div class="content">
    <div class="sec">
      <h4>原文</h4>
      <div id="anaSrc" class="quote"></div>
    </div>
    <div class="sec">
      <h4>① 中文翻譯</h4>
      <div id="anaZh" class="zh"></div>
    </div>
    <div class="sec">
      <h4>②～⑤ 文法與片語</h4>
      <ul id="anaGram" class="zh list"></ul>
    </div>
    <div id="extraQ" style="margin-top:10px">
      <input id="extraQInput" placeholder="想問什麼？（針對選取文字）">
      <button id="extraQBtn" class="secondary">送出問題</button>
      <div id="extraQAns" class="help"></div>
    </div>
  </div>
</div>

<!-- 底部工具列：翻譯與文法（只有選取後才顯示） -->
<div class="bottom-bar" id="bottomBar">
  <button id="doExplain" class="secondary">翻譯與文法</button>
  <span class="status" id="selStatus">請先在左側文章中框選句子或片段</span>
</div>

<!-- TTS 收合抽屜（靠右，生成語音後才顯示） -->
<div class="tts-drawer" id="ttsDrawer">
  <div class="handle">▶</div>
  <div style="font-weight:700;margin-bottom:6px">語音播放</div>
  <div class="row" style="margin-bottom:6px">
    <label class="help">語速：</label>
    <input id="rateRange" type="range" min="0.5" max="1.5" step="0.05" value="1">
    <span id="rateLabel" class="help">1.00×</span>
  </div>
  <div class="row">
    <button id="ttsPlayAll">朗讀全部</button>
    <button id="ttsStop" class="secondary">停止</button>
  </div>
  <div class="help" style="margin-top:6px">對話：A/B 依你選擇的性別偏好自動分配；段落喇叭僅在「生成語音」後顯示。</div>
</div>

<script>
/* ========= ✅ 換成你的 Apps Script Web App URL ========= */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyo3LWQPC-XOdEmslQoIbFrrF4vbZ1egyAKMmUixVgsRP7RQ8ebnRn2WqL6h7cubQwJyQ/exec';

// ===== 字典開關（存本機 localStorage） =====
const DICT_OFF_KEY = 'word-noter.dict.off'; // '1' 表關、'0' 或缺值表開
function isDictOff(){
  try{ return localStorage.getItem(DICT_OFF_KEY) === '1'; }catch{ return false; }
}
function setDictOff(v){
  try{ localStorage.setItem(DICT_OFF_KEY, v ? '1' : '0'); }catch{}
}
function updateDictToggleUI(){
  const btn = document.getElementById('toggleDict');
  if(!btn) return;
  if(isDictOff()){
    btn.textContent = '字典：關';
    btn.title = '點一下開啟字典卡';
  }else{
    btn.textContent = '字典：開';
    btn.title = '點一下關閉字典卡';
  }
}

  
/* ========= 小工具 ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
/* === 語言切換 & 分離儲存鍵 === */
function getLang(){ const el = document.getElementById('langSelect'); return el ? el.value : 'en'; }
const STORE_KEYS = { en:'word-noter.en.v1', de:'word-noter.de.v1' };
const QUEUE_KEYS = { en:'word-noter.queue.en.v1', de:'word-noter.queue.de.v1' };

function updateUILang(){
  const lang = getLang();
  const lab = document.querySelector('label[for="src"]');
  const ta  = document.getElementById('src');
  const title = document.querySelector('header .wrap strong');
  const topic = document.getElementById('customTopic');

  if(lang === 'de'){
    lab && (lab.textContent = '在下方貼上德文文章：');
    ta && (ta.placeholder = 'Füge deinen deutschen Text hier ein…');
    title && (title.textContent = '本地德文點字查詢＋生字本');
    topic && (topic.placeholder = 'Gib dein Wunschthema/Genre ein (z. B. eine überzeugende Abhandlung über erneuerbare Energien)…');
  }else{
    lab && (lab.textContent = '在下方貼上英文文章：');
    ta && (ta.placeholder = 'Paste your English article here...');
    title && (title.textContent = '本地英文點字查詢＋生字本');
    topic && (topic.placeholder = '輸入想要生成的主題／風格（例如：關於可再生能源的說服文）');
  }
}


function resetWordQ(){
  const i = document.getElementById('wordQInput');
  const a = document.getElementById('qaBox');
  if(i) i.value = '';
  if(a) a.textContent = '';
}
function resetAnalysisQ(){
  const i = document.getElementById('extraQInput');
  const a = document.getElementById('extraQAns');
  if(i) i.value = '';
  if(a) a.textContent = '';
}


function _curStoreKey(){ return STORE_KEYS[getLang()] || STORE_KEYS.en; }
function _curQueueKey(){ return QUEUE_KEYS[getLang()] || QUEUE_KEYS.en; }

const reader = $('#reader');
const card = $('#card');
const defsBox = $('#defs');
const cardMeta = $('#cardMeta');
const cardTitle = $('#cardTitle');
const noteInput = $('#noteInput');
const offlineTip = $('#offlineTip');

const analysisCard = $('#analysisCard');
const anaSrc = $('#anaSrc');
const anaZh = $('#anaZh');
const anaGram = $('#anaGram');
const selPreview = $('#selPreview');

const bottomBar = $('#bottomBar');
const doExplainBtn = $('#doExplain');
const selStatus = $('#selStatus');

const ttsDrawer = $('#ttsDrawer');
const rateRange = $('#rateRange');
const rateLabel = $('#rateLabel');

let lastSelectionText = '';



/* ========= TTS 狀態 ========= */
let currentAudio = null;
let playQueue = [];
let ttsGenerated = false;         // 是否已生成語音
const segAudios = new Map();      // idx -> { url, voice }
const VOICE_MALE = 'verse';
const VOICE_FEMALE = 'alloy';

/* ========= 常用工具 ========= */
function nowISO(){ return new Date().toISOString(); }
function toLowerAlpha(word){ return (word||'').toLowerCase(); }
function loadWords(){ try{ return JSON.parse(localStorage.getItem(_curStoreKey())) || [] } catch { return [] } }
function saveWords(list){ localStorage.setItem(_curStoreKey(), JSON.stringify(list)); }
function loadQueue(){ try{ return JSON.parse(localStorage.getItem(_curQueueKey())) || [] } catch { return [] } }
function saveQueue(q){ localStorage.setItem(_curQueueKey(), JSON.stringify(q)); }
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function getSelectedGenre(){const el = document.getElementById('genreSelect');return el ? el.value : '';}
function getCustomTopic(){
  const el = document.getElementById('customTopic');
  return el ? (el.value || '').trim() : '';
}

function getTargetLen(){
  const el = document.getElementById('lengthInput');
  const v = parseInt(el?.value || '500', 10);
  if (!isFinite(v)) return 500;
  return Math.max(100, Math.min(1200, v));  // 下限 100，上限 1200
}


function sanitizeSegmentForTTS(text, genre){let t = text || '';if (genre === 'dialogue') {// 刪除行首的說話者標籤：A: / B: / C: 或名字: 也一併處理；支援全形冒號
 t = t.replace(/^\s*(?:[A-Z]|[A-Za-z]{1,20})\s*[:：]\s*/, '');}return t.trim();}
 /* === 段落高亮：正在播放哪一段 === */
let currentSegIdx = null;
function clearAllSegHighlights(){
  $$('.reader .seg.playing').forEach(el=> el.classList.remove('playing'));
  currentSegIdx = null;}
function highlightSegmentByIndex(idx){
  clearAllSegHighlights();
  const seg = document.querySelector(`.reader .seg[data-i="${idx}"]`);
  if (seg){
    seg.classList.add('playing');
    currentSegIdx = idx;}}


/* ========= Google Sheet 送寫（失敗排隊） ========= */
async function postToSheet(payload){
  if (!WEB_APP_URL || !/^https:\/\//.test(WEB_APP_URL)) return;
  const body = JSON.stringify(payload);
  try{
    await fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/json' }, body });
    return true;
  }catch{
    const q = loadQueue(); q.push({ body, ts: Date.now() }); saveQueue(q);
    return false;
  }
}
async function flushQueue(){
  const q = loadQueue(); if(!q.length) return;
  const remain = [];
  for (const item of q){
    try{
      await fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', headers:{ 'Content-Type':'application/json' }, body:item.body });
    }catch{ remain.push(item); }
  }
  saveQueue(remain);
}
window.addEventListener('online', flushQueue);
setInterval(flushQueue, 8000);

/* ========= 本機資料（生字本） ========= */
function upsertWord(word, payload = {}, inc = true){
  const base = loadWords();
  const key = toLowerAlpha(word);
  const idx = base.findIndex(x => x.word === key);
  if (idx >= 0){
    base[idx] = {
      ...base[idx],
      count: inc ? (base[idx].count || 0) + 1 : (base[idx].count || 0),
      lastSeen: nowISO(),
      pos: payload.pos ?? base[idx].pos,
      phon: payload.phon ?? base[idx].phon,
      defs: payload.defs ?? base[idx].defs,
      note: payload.note ?? base[idx].note,
      display: payload.display ?? base[idx].display
    };
  } else {
    base.push({
      word: key, display: payload.display || word,
      count: inc ? 1 : 0, firstSeen: nowISO(), lastSeen: nowISO(),
      pos: payload.pos || '', phon: payload.phon || '',
      defs: payload.defs || [], note: payload.note || ''
    });
  }
  saveWords(base);
  renderWordList();
  applyHFClassesToReader();
}
function adjustWordCount(word, delta){
  const base = loadWords();
  const key = toLowerAlpha(word);
  const idx = base.findIndex(x => x.word === key);
  if(idx < 0) return;
  base[idx].count = Math.max(0, (base[idx].count||0) + delta);
  base[idx].lastSeen = nowISO();
  saveWords(base);
  renderWordList();
  applyHFClassesToReader();
}
function updateWordNote(word, note){
  const base = loadWords();
  const key = toLowerAlpha(word);
  const idx = base.findIndex(x => x.word === key);
  if(idx >= 0){
    base[idx].note = note;
    base[idx].lastSeen = nowISO();
    saveWords(base);
    renderWordList();
  }
}
function getWord(word){
  const base = loadWords();
  return base.find(x => x.word === toLowerAlpha(word));
}

/* ========= 高頻標示 ========= */
function getTopNWordKeys(n){
  return (loadWords()||[])
    .slice()
    .sort((a,b)=>{
      const c = (b.count||0)-(a.count||0);
      return c!==0 ? c : (b.lastSeen||'').localeCompare(a.lastSeen||'');
    })
    .slice(0,n)
    .map(x=>x.word);
}
function applyHFClassesToReader(){
  const top15 = new Set(getTopNWordKeys(15));
  const top50 = new Set(getTopNWordKeys(50));
  $$('.reader .word').forEach(el=>{
    const w = toLowerAlpha(el.dataset.w);
    if(!el.classList.contains('deducted')){
      el.classList.remove('hf15','hf50');
      if(top15.has(w)) el.classList.add('hf15');
      else if(top50.has(w)) el.classList.add('hf50');
    }
  });
}

/* ========= 文章處理：分段 + 單字 tokenize（初始不放喇叭） ========= */
function tokenizeParagraphToHTML(textLine){
  const lang = getLang();
  // 單字樣式：英語 / 德語（允許連字號、撇號）
  const WORD = lang === 'de'
    ? /[\p{L}]+(?:-[\p{L}]+)*(?:'[\p{L}]+)?/gu
    : /[A-Za-z]+(?:'[A-Za-z]+)?/g;

  const out = [];
  let last = 0, m;
  while ((m = WORD.exec(textLine)) !== null){
    // 先推非字元片段
    if(m.index > last){
      const mid = textLine.slice(last, m.index)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      out.push(mid);
    }
    const tok = m[0];
    out.push(`<span class="word" data-w="${tok}">${tok}</span>`);
    last = WORD.lastIndex;
  }
  if(last < textLine.length){
    out.push(textLine.slice(last).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));
  }
  return out.join('');
}

function compile(){
  // 重置喇叭與抽屜
  ttsGenerated = false;
  segAudios.clear();
  ttsDrawer.classList.remove('show');

  const raw = $('#src').value;
  if(!raw.trim()){
    reader.innerHTML = '<div class="empty">請先貼上文章再產生。</div>';
    return;
  }

  // 分行後，過濾掉空白行
  const lines = raw.split(/\n/).map(l => l.trim()).filter(l => l.length > 0);

  if(lines.length === 0){
    reader.innerHTML = '<div class="empty">內容皆為空白。</div>';
    return;
  }

  // 轉為可點文字
  const html = lines.map((line, i)=>{
    const inner = tokenizeParagraphToHTML(line);
    return `<div class="seg" data-i="${i}">${inner}</div>`;
  }).join('\n');

  reader.innerHTML = html;

  // 綁定字事件
  $$('.reader .word').forEach(el=>{
    el.addEventListener('click', onWordClickHandler);
    el.addEventListener('dblclick', onWordDblClickHandler);
  });

  // 播放單段事件
  reader.removeEventListener('click', segPlayHandler);
  reader.addEventListener('click', segPlayHandler);

  applyHFClassesToReader();

}

/* === 單字卡：先顯示骨架，再等結果回填 === */
function showWordCardSkeleton(display, word){
  card.style.display = 'block';
  resetWordQ();
  cardTitle.innerHTML =
    `<span class="badge">查詢</span> <strong style="font-size:18px">${display}</strong>`;
  cardMeta.textContent = '';         // 詞性先空著
  offlineTip.style.display = 'none'; // 先不顯示離線

  // 先出一條「載入中…」避免空白
  defsBox.innerHTML = `<li style="color:#94a3b8">載入中⋯</li>`;
}

/* === 取得定義後，統一回填到卡片與本機儲存 === */
function updateWordCardFromInfo(display, word, info){
  if(!info){
    defsBox.innerHTML = `<li>（離線或查無結果，請自行補充備註作為臨時解釋。）</li>`;
    offlineTip.style.display = 'block';
    return;
  }
  // 更新標題與欄位
  cardTitle.innerHTML =
    `<span class="badge">查詢</span> <strong style="font-size:18px">${display}</strong>` +
    (info?.phon ? `<span class="phon">/${info.phon}/</span>` : '');
  cardMeta.textContent = info?.pos ? `詞性：${info.pos}` : '';

  // 回填條目
  defsBox.innerHTML = '';
  (info.defs||[]).slice(0,5).forEach(d=>{
    const li = document.createElement('li');
    li.innerHTML = d;
    defsBox.appendChild(li);
  });

  // 存回本機（不再增加點擊次數）
  upsertWord(word, {
    display,
    pos: info.pos || '',
    phon: info.phon || '',
    defs: info.defs ? info.defs.slice(0,3) : []
  }, false);

  // 傳到 Sheet（英文才送；與你原本一致）
  if(getLang() !== 'de'){
    const row = getWord(word);
    postToSheet({
      lang: getLang(),
      word: row.word, display: row.display||word, pos: row.pos||'', phon: row.phon||'',
      defs: row.defs||[], note: row.note||'', count: row.count||1,
      pageUrl: location.href, userAgent: navigator.userAgent
    });
  }
}

  
/* ========= 字典查詢：改為「純生成」 ========= */
/* BEGIN: paste this whole block */

async function generateEnglishEntry(word){
  const provider = getSelectedProvider();
  const model = getSelectedModel();
  const apiKey = (provider === 'grok')
    ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
    : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

  // 若沒金鑰就回 null，UI 會顯示「離線提示」
  if(!apiKey) return null;

  const system = 'You are a concise English lexicographer. Reply in Traditional Chinese.';
  const user = `請用條列回覆單字「${word}」的精簡詞條（不要多餘說明）：
- 中文意思
- 詞性（英文縮寫，如 n., v., adj.；若多義可列最多二個）
- 音標（若不確定可略）
- 2–3 條核心義項（英文解釋，並附一個英文例句＋簡短中譯）
輸出格式例如：
詞性：n., v.
音標：/.../
義項：
1) ...（例：...｜譯：...）
2) ...（例：...｜譯：...）`;

  const txt = await doChat({
    provider, apiKey, model,
    messages: [{role:'system',content:system},{role:'user',content:user}],
    temperature: 0.3
  });

  if(!txt) return null;

  // 解析模型輸出 → 與既有 UI 結構相容
  const lines = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  let pos = '', phon = '';
  const defs = [];
  for(const ln of lines){
    if(/^詞性[:：]/.test(ln)) pos  = ln.replace(/^詞性[:：]\s*/,'').trim();
    else if(/^音標[:：]/.test(ln)) phon = ln.replace(/^音標[:：]\s*/,'').trim().replace(/^\/|\/$/g,'');
    else if(/^義項[:：]/.test(ln)) { /* 標題行略過 */ }
    else defs.push(ln);
  }
  if(!defs.length) return null;
  return { phon, pos, defs: defs.slice(0,5) };
}

async function lookupDefinition(word){
  // 純生成：英文走 generateEnglishEntry；德文走既有的 generateGermanEntry（下面那一段）
  if(getLang() === 'de'){
    return await generateGermanEntry(word);
  }else{
    return await generateEnglishEntry(word);
  }
}

/* END: paste this whole block */

/* === 生成德文字典（基本） === */
async function generateGermanEntry(word){
  const provider = getSelectedProvider();
  const model = getSelectedModel();  // 可為空，doChat 會套預設
  const apiKey = (provider === 'grok') ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
                                       : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());
  if(!apiKey) return {
    phon:'', pos:'', defs:[ '（請先填入 API Key；或點「更多」前往補充）' ],
    deBasic:{ lemma:'', articles:'', numberForms:'', meaning:'', pos:'' }
  };

  const system = 'Du bist ein deutscher Lexikograph. Antworte kompakt in Traditionellem Chinesisch.';
  const user = `針對這個德文單字以條列回覆（僅回覆內容，不要加前後說明）：
「${word}」
詞性：
意思：
原型：
（若是名詞才顯示）定冠詞：
（若是名詞才顯示）複數：
（若是動詞才顯示，顯示在同一行）動詞變化：
（若是動詞才顯示，顯示在同一行，呈現過去式與過去分詞）過去式：
（若是形容詞才顯示）比較級／最高級：
`;

  const txt = await doChat({
    provider, apiKey, model,
    messages: [{role:'system',content:system},{role:'user',content:user}],
    temperature: 0.3
  });

  const lines = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  const pretty = [];
  let pos = '';
  for(const ln of lines){ pretty.push(ln); if(/^詞性/.test(ln)){ pos = ln.replace(/^詞性[:：]\s*/,''); } }
  return { phon:'', pos, defs: pretty, deBasic: { raw: txt } };
}


/* === 生成德文「更多」內容 === */
async function generateGermanMore(word){
  const provider = getSelectedProvider();
  const model = getSelectedModel();
  const apiKey = (provider === 'grok') ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
                                       : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());
  if(!apiKey) return { more: '（請先在右側輸入 API Key）' };

  const system = 'Du bist ein deutscher Lexikograph. Antworte knapp in Traditionellem Chinesisch。';
  const user = `請針對德文單字「${word}」補充以下欄位，條列呈現（僅回覆內容，不要額外說明）：
常見搭配詞：
例句：1. … 2. …    （例句附簡短中文譯意）
其他備註（例如：可分動詞／介系詞搭配／語氣差異等）：`;

  const txt = await doChat({
    provider, apiKey, model,
    messages: [{role:'system',content:system},{role:'user',content:user}],
    temperature: 0.4
  });

  return { more: txt || '（生成失敗）' };
}


/* ========= 點擊 / 雙擊 ========= */
function onWordClickHandler(e){
  const el = e.currentTarget;
  if (el._clickTimer) clearTimeout(el._clickTimer);
  el._clickTimer = setTimeout(()=>{ processSingleClick(el); el._clickTimer=null; }, 250);
}
function onWordDblClickHandler(e){
  const el = e.currentTarget;
  if (el._clickTimer){ clearTimeout(el._clickTimer); el._clickTimer=null; }
  processDoubleClick(el);
}
async function processSingleClick(el){
  const display = el.dataset.w;
  const word = toLowerAlpha(display);

  // ✅ 立即給使用者「有點到」的回饋（更明顯：外環＋彈跳）
  el.classList.add('clicked');
  setTimeout(()=> el.classList.remove('clicked'), 700);

  // 若這個字之前被雙擊扣分成「紅色」：第一次點擊改為「取消紅色」並恢復高頻框；就先結束（維持你原本邏輯）
  const anyDeducted = $$('.reader .word').some(node =>
    toLowerAlpha(node.dataset.w) === word && node.classList.contains('deducted')
  );
  if(anyDeducted){
    $$('.reader .word').forEach(node=>{
      if (toLowerAlpha(node.dataset.w) === word){
        node.classList.remove('deducted');
      }
    });
    applyHFClassesToReader();
    return;
  }

    // 如果使用者關掉字典：只做點擊回饋與計次，不開卡、不查字典
  if(isDictOff()){
    upsertWord(word, { display }, true);   // 照常 +1 次數
    applyHFClassesToReader();              // 藍/綠框照常更新
    return;                                // 結束，不開啟字典卡
  }

  // ✅ 字典是開啟狀態：先把卡片打開骨架，再去查
  showWordCardSkeleton(display, word);

  // 記一次點擊（維持你原本：單擊會 +1）
  upsertWord(word, { display }, true);
  applyHFClassesToReader(); // 更新藍/綠框


  try{
    // ✅ 背景去生成字典（英文/德文各自走你原本的 lookupDefinition）
    const info = await lookupDefinition(word);

    // 德文需要「更多」按鈕的那塊，你原本在 processSingleClick 裡有分流
    if(getLang() === 'de'){
      // 回填基本欄位
      if(info && info.defs?.length){
        updateWordCardFromInfo(display, word, info);
      }else{
        defsBox.innerHTML = '<li>（離線或生成失敗）</li>';
        offlineTip.style.display = 'block';
      }

      // ==== 保留你原本的「德文更多」按鈕行為 ====
      let moreBtn = document.getElementById('deMoreBtn');
      if(moreBtn) moreBtn.remove();
      moreBtn = document.createElement('button');
      moreBtn.id = 'deMoreBtn';
      moreBtn.className = 'secondary';
      moreBtn.style.marginTop = '8px';
      moreBtn.textContent = '更多';
      const contentBox = card.querySelector('.content');
      contentBox.appendChild(moreBtn);

      let moreBox = document.getElementById('deMoreBox');
      if(!moreBox){
        moreBox = document.createElement('div');
        moreBox.id = 'deMoreBox';
        moreBox.className = 'zh';
        moreBox.style.marginTop = '8px';
        contentBox.appendChild(moreBox);
      }else{
        moreBox.innerHTML = '';
      }

      moreBtn.onclick = async ()=>{
        try{
          moreBtn.disabled = true; const old = moreBtn.textContent; moreBtn.textContent='生成中…';
          const extra = await generateGermanMore(display);
          moreBox.innerHTML = `
<div style="border-top:1px solid var(--border); margin-top:8px; padding-top:8px">
  ${extra.more.replace(/\n/g,'<br>')}
</div>`;
          moreBtn.remove();
        }catch(err){
          moreBox.textContent = '（生成失敗：' + err.message + '）';
          moreBtn.disabled = false; moreBtn.textContent='更多';
        }
      };
      // ==== 德文分流結束 ====
    }else{
      // 英文：直接回填
      updateWordCardFromInfo(display, word, info);
      // 確保沒有殘留的德文「更多」UI
      const moreBtn = document.getElementById('deMoreBtn'); if(moreBtn) moreBtn.remove();
      const moreBox = document.getElementById('deMoreBox'); if(moreBox) moreBox.remove();
    }
  }catch(err){
    // 失敗也給明確訊息
    defsBox.innerHTML = `<li>（查詢失敗：${(err&&err.message)||'未知錯誤'}）</li>`;
    offlineTip.style.display = 'block';
  }
}

function processDoubleClick(el){
  const display = el.dataset.w;
  const word = toLowerAlpha(display);
  adjustWordCount(word, -2);
  $$('.reader .word').forEach(node=>{
    if (toLowerAlpha(node.dataset.w) === word){
      node.classList.remove('hf15','hf50');
      node.classList.add('deducted');
    }
  });
  el.animate([{transform:'scale(1.02)'},{transform:'scale(1)'}],{duration:150});
}

/* ========= 生字本側欄 ========= */
function renderWordList(){
  const box = $('#wordList');
  const q = $('#q').value.trim().toLowerCase();
  const all = loadWords()
    .sort((a,b)=> (b.lastSeen||'').localeCompare(a.lastSeen||''));
  const list = q ? all.filter(x =>
        x.word.includes(q) || (x.note||'').toLowerCase().includes(q) ) : all;

  if(!list.length){
    box.innerHTML = '<div class="empty">目前沒有生字。</div>';
    return;
  }

  box.innerHTML = list.map(x=>`
    <div class="item" data-w="${x.word}">
      <div>
        <div class="w">${x.display || x.word}${x.phon ? `<span class="phon"> /${x.phon}/</span>`:''}</div>
        <div class="t">${x.pos || ''}</div>
        ${x.defs?.length ? `<div class="t">• ${x.defs[0]}</div>`:''}
        ${x.note ? `<div class="t">備註：${x.note}</div>`:''}
      </div>
      <div class="c">×${x.count||0}</div>
      <button class="secondary" onclick="focusWord('${x.word}')">查看</button>
    </div>
  `).join('');
}
async function focusWord(word){
  const targets = $$('.reader .word');
  let n = 0;
  targets.forEach(el=>{
    if(toLowerAlpha(el.dataset.w)===word){
      if(n===0){
        el.scrollIntoView({behavior:'smooth', block:'center'});
        el.animate([{background:'rgba(56,189,248,.20)'},{background:'transparent'}],{duration:900});
      }
      n++;
    }
  });

  const x = getWord(word);
  if(!x) return;

  card.style.display = 'block';
  cardTitle.innerHTML = `<span class="badge">查詢</span> <strong style="font-size:18px">${x.display || x.word}</strong>` +
                        (x.phon ? `<span class="phon">/${x.phon}/</span>` : '');
  cardMeta.textContent = x.pos ? `詞性：${x.pos}` : '';
resetWordQ();
  // ✅ 這裡放你的段落：
  if(x.defs?.length){
    defsBox.innerHTML = x.defs.map(d=>`<li>${d}</li>`).join('');
  } else {
    const info = await lookupDefinition(word);
    if(info){
      upsertWord(word, info, false);
      defsBox.innerHTML = info.defs.map(d=>`<li>${d}</li>`).join('');
    } else {
      defsBox.innerHTML = '<li>（查無定義）</li>';
    }
  }

  noteInput.value = x.note || '';
  offlineTip.style.display = x.defs?.length ? 'none' : 'block';

}


/* ========= 匯出 / 匯入 ========= */
function download(filename, text){
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function exportCSV(){
  const rows = loadWords();
  const head = ['word','display','count','firstSeen','lastSeen','pos','phon','defs','note'];
  const csv = [head.join(',')].concat(rows.map(r=>{
    const vals = [
      r.word, r.display||'', r.count||0, r.firstSeen||'', r.lastSeen||'',
      r.pos||'', r.phon||'', (r.defs||[]).join(' | '), r.note||''
    ].map(v=> `"${String(v).replace(/"/g,'""')}"`);
    return vals.join(',');
  })).join('\n');
  download('words.csv', csv);
}
function exportJSON(){ download('words.json', JSON.stringify(loadWords(), null, 2)); }
function importJSONFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(!Array.isArray(data)) throw new Error('格式錯誤');
      const cur = loadWords();
      const map = new Map(cur.map(x=>[x.word,x]));
      data.forEach(x=>{
        const k = x.word;
        const exists = map.get(k);
        if(!exists){ map.set(k,x); }
        else{
          map.set(k, (new Date(x.lastSeen||0) > new Date(exists.lastSeen||0)) ? {...exists,...x} : {...x,...exists});
        }
      });
      saveWords(Array.from(map.values()));
      renderWordList();
      applyHFClassesToReader();
      alert('匯入完成');
    }catch(err){ alert('匯入失敗：'+err.message); }
  };
  reader.readAsText(file);
}

/* ========= 解析 CSV（支援引號、逗號、換行） ========= */
function parseCSV(text){
  const rows = [];
  let i = 0, cur = [], cell = '', inQ = false;

  while(i < text.length){
    const ch = text[i];

    if(inQ){
      if(ch === '"'){
        if(text[i+1] === '"'){ cell += '"'; i += 2; continue; } // 轉義 ""
        inQ = false; i++; continue;
      }
      cell += ch; i++; continue;
    }else{
      if(ch === '"'){ inQ = true; i++; continue; }
      if(ch === ','){ cur.push(cell); cell=''; i++; continue; }
      if(ch === '\r'){
        if(text[i+1] === '\n') i++;
        cur.push(cell); rows.push(cur); cell=''; cur=[]; i++; continue;
      }
      if(ch === '\n'){
        cur.push(cell); rows.push(cur); cell=''; cur=[]; i++; continue;
      }
      cell += ch; i++; continue;
    }
  }
  // 收尾
  if(inQ){ /* 容錯：未關引號也直接收尾 */ }
  cur.push(cell); rows.push(cur);

  // 去掉 BOM 與首尾空白
  return rows.map(r => r.map(c => (c||'').replace(/^\uFEFF/,'').trim()));
}

/* ========= 匯入 CSV 主程式（每個字 +5 點擊） ========= */
function importCSVText(csvText){
  const grid = parseCSV(csvText).filter(r => r.some(c => c && c.length));
  if(!grid.length){ alert('CSV 無內容'); return; }

  // 判斷是否有標題列
  const head = grid[0].map(x => x.toLowerCase());
  const hasHeader = ['word','display','pos','phon','defs','note','count'].some(k => head.includes(k));

  // 準備合併到現有本機資料
  const base = loadWords();
  const map = new Map(base.map(x => [x.word, x]));

  let added = 0, updated = 0;

  const rows = hasHeader ? grid.slice(1) : grid;
  const idx = (name) => head.indexOf(name);

  for(const r of rows){
    // 取欄位
    let w = '';
    if(hasHeader){
      w = (r[idx('word')] || '').trim();
    }else{
      w = (r[0] || '').trim();
    }
    if(!w) continue;

    const key = toLowerAlpha(w);
    const display = hasHeader ? (r[idx('display')] || w).trim() : w;
    const pos  = hasHeader ? (r[idx('pos')]  || '').trim() : '';
    const phon = hasHeader ? (r[idx('phon')] || '').trim() : '';
    const defsRaw = hasHeader ? (r[idx('defs')] || '').trim() : '';
    const note = hasHeader ? (r[idx('note')] || '').trim() : '';
    const countCsv = hasHeader ? (parseInt(r[idx('count')] || '0',10) || 0) : 0;

    const defs = defsRaw
      ? defsRaw.split('|').map(s => s.trim()).filter(Boolean)
      : [];

    const now = nowISO();
    const existed = map.get(key);

    if(existed){
      map.set(key, {
        ...existed,
        display: display || existed.display || w,
        pos: pos || existed.pos || '',
        phon: phon || existed.phon || '',
        defs: defs.length ? defs : (existed.defs || []),
        note: note || existed.note || '',
        count: Math.max(0, (existed.count||0)) + 5 + (countCsv||0),
        lastSeen: now
      });
      updated++;
    }else{
      map.set(key, {
        word: key,
        display: display || w,
        count: 5 + (countCsv||0),       // ✅ 首次匯入就 +5
        firstSeen: now,
        lastSeen: now,
        pos, phon, defs, note
      });
      added++;
    }
  }

  saveWords(Array.from(map.values()));
  renderWordList();
  applyHFClassesToReader();
  alert(`CSV 匯入完成：新增 ${added} 筆、更新 ${updated} 筆（每字額外 +5 次點擊）。`);
}

/* ========= 匯入 CSV：讀檔 ========= */
function importCSVFile(file){
  const fr = new FileReader();
  fr.onload = () => {
    try{
      importCSVText(String(fr.result||''));
    }catch(err){
      alert('匯入失敗：' + err.message);
    }
  };
  fr.readAsText(file, 'utf-8');
}


/* ========= OpenAI 內容生成（保留既有三種類型） ========= */
async function doChat({ provider, apiKey, model, messages, temperature=0.7 }) {
  const p = (provider || 'openai');
  const m = model && model.trim();
  if(p === 'grok'){
    const key = apiKey || loadGrokKey();
    if(!key) throw new Error('請先填入 Grok API Key');
    const useModel = m || 'grok-4'; // 若報錯可改 'grok-4-fast' 或退回 'grok-2-latest'
    const resp = await fetch('https://api.x.ai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: useModel, messages, temperature })
    });
    if(!resp.ok){
      const msg = await resp.text().catch(()=>resp.status);
      throw new Error('Grok 失敗：' + msg);
    }
    const data = await resp.json();
    return (data.choices?.[0]?.message?.content || '').trim();
  }

  // default: OpenAI
  {
    const key = apiKey || loadOpenAIKey();
    if(!key) throw new Error('請先填入 OpenAI API Key');
    const useModel = m || 'gpt-4o-mini';
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: useModel, messages, temperature })
    });
    if(!resp.ok){
      const msg = await resp.text().catch(()=>resp.status);
      throw new Error('OpenAI 失敗：' + msg);
    }
    const data = await resp.json();
    return (data.choices?.[0]?.message?.content || '').trim();
  }
}

const OPENAI_KEY_STORAGE = 'word-noter.openai.key';
const GROK_KEY_STORAGE = 'word-noter.grok.key';
function loadGrokKey(){ try { return localStorage.getItem(GROK_KEY_STORAGE) || ''; } catch { return ''; } }
function saveGrokKey(k){ localStorage.setItem(GROK_KEY_STORAGE, (k||'').trim()); }

function getSelectedProvider(){
  const el = document.getElementById('providerSelect');
  return el ? el.value : 'openai';
}
function getSelectedModel(){
  const sel = document.getElementById('modelSelect');
  const custom = document.getElementById('modelCustom');
  const fromSelect = sel ? (sel.value || '').trim() : '';
  const fromCustom = custom ? (custom.value || '').trim() : '';
  return fromCustom || fromSelect;
}
function loadOpenAIKey(){ try { return localStorage.getItem(OPENAI_KEY_STORAGE) || ''; } catch { return ''; } }
function saveOpenAIKey(k){ localStorage.setItem(OPENAI_KEY_STORAGE, (k||'').trim()); }
function getTopNWordsLocal(n=15){
  const all = loadWords();
  return (all||[])
    .slice()
    .sort((a,b)=>{
      const c = (b.count||0) - (a.count||0);
      return c !== 0 ? c : (b.lastSeen||'').localeCompare(a.lastSeen||'');
    })
    .slice(0, n)
    .map(x => x.display || x.word)         // 保留原樣（支援德文大寫名詞與變音字母）
    .filter(Boolean);
}
function buildVariantPattern(w){
  const lang = getLang();
  const root = (w || '').trim();
  if(!root) return null;

  if(lang === 'de'){
    // 德文：大小寫不敏感（名詞常大寫），允許 Unicode 字母
    return new RegExp('\\b' + root.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'iu');
  }

  // 英文（原規則）
  const base = root.toLowerCase();
  const forms = new Set([base, base+'s']);
  if (/(s|x|z|ch|sh|o)$/.test(base)) forms.add(base + 'es');
  if (/[^aeiou]y$/.test(base)) { forms.add(base.slice(0,-1) + 'ies'); forms.add(base.slice(0,-1) + 'ied'); }
  if (!base.endsWith('e')) { forms.add(base + 'ed'); forms.add(base + 'ing'); forms.add(base + 'ings'); }
  else { forms.add(base + 'd'); forms.add(base.slice(0,-1) + 'ing'); forms.add(base.slice(0,-1) + 'ings'); }
  forms.add(base + 'er'); forms.add(base + 'est'); forms.add(base + 'ly');
  ['ness','ful','less','ment','tion','sion','ation','able','ible','al','ive','ish','ity','ous','y']
    .forEach(suf => forms.add(base + suf));
  const IRREG = {
    child: ['children'], person: ['people'], man: ['men'], woman: ['women'],
    mouse: ['mice'], goose: ['geese'], foot: ['feet'], tooth: ['teeth'],
    go: ['went','gone'], be: ['am','is','are','was','were','been','being'],
    have: ['has','had'], do: ['does','did','done','doing']
  };
  if(IRREG[base]) IRREG[base].forEach(v=>forms.add(v));
  return new RegExp('\\b(' + Array.from(forms).map(escapeRegExp).join('|') + ')\\b', 'i');
}

function wordsMissingFrom(text, words){
  const t = text || '';
  const missing = [];
  for(const w of words){
    const re = buildVariantPattern(w);
    if(re && !re.test(t)) missing.push(w);
  }
  return missing;
}

function buildUserPromptByType({ lang, type, words, level, customTopic, targetCount }){
  const lc = (level||'B1').toUpperCase();
  const listText = words.join(', ');
  const commonRuleEN = words.length
    ? `Include EVERY ONE of the following target words at least once (allow inflected/derived forms): ${listText}`
    : `No specific target words are required.`;
  const commonRuleDE = words.length
    ? `Verwende JEDES der folgenden Zielwörter mindestens einmal (Groß-/Kleinschreibung egal, Beugungen erlaubt): ${listText}`
    : `Keine bestimmten Zielwörter erforderlich.`;

  const isDE = (lang === 'de');
    const approxLenEN = `about ${targetCount || 500} words`;
  const approxLenDE = `ca. ${targetCount || 500} Wörter`;


  if(type === 'fairy_tale'){
    return isDE
      ? `Schreibe ein zusammenhängendes Märchen auf Deutsch (CEFR ${lc}), ${approxLenDE}.
${commonRuleDE}
Keine Aufzählungen. Nur Absätze als Fließtext.`
      : `Write a whimsical, coherent fairy tale in CEFR ${lc} English, ${approxLenEN}.
${commonRuleEN}
Do not use bullet points. Output only the story as paragraphs.`;
  }

  if(type === 'dialogue'){
    return isDE
      ? `Schreibe einen natürlichen Alltagsdialog auf Deutsch (CEFR ${lc}), ${approxLenDE}.
${commonRuleDE}
Format strikt:
- Verwende Sprecherlabels wie "A:" und "B:" (optional "C:").
- JEDER Turn steht in einer eigenen Zeile (genau eine Leerzeile dazwischen vermeiden).
- Keine Aufzählungen oder Nummerierungen.
- Kurze, realistische Turns.`
      : `Write a natural daily-life conversation in CEFR ${lc} English, ${approxLenEN}.
${commonRuleEN}
Format strictly:
- Use alternating speaker labels like "A:" and "B:" (optionally "C:").
- PUT EACH TURN ON ITS OWN LINE (use a single newline between turns, no blank lines).
- Do NOT use bullet points or numbering.
- Keep turns concise and realistic.`;
  }

  if(type === 'article'){
    return isDE
      ? `Schreibe einen informativen Fachartikel auf Deutsch (CEFR ${lc}), ${approxLenDE}.
Wähle ein zufälliges Themenfeld: Medizin, Recht, Finanzen, Ingenieurwesen, Umwelt, Bildung, Technologie, Psychologie, Design, Stadtplanung, Public Health, Landwirtschaft, Energie, Verkehr, Data Science.
${commonRuleDE}
Zielgruppe: gebildete Allgemeinheit. Keine Aufzählungen; gut strukturierte Absätze.`
      : `Write an informative professional article (${approxLenEN}) in CEFR ${lc} English.
Pick a random field from: medicine, law, finance, engineering, environmental science, education, technology, psychology, design, urban planning, public health, agriculture, energy, transportation, data science.
${commonRuleEN}
Target educated general readers. No bullet lists; use well-formed paragraphs only.`;
  }

  /* === NEW: custom 自訂主題 === */
  if(type === 'custom'){
    const topic = (customTopic || '').trim();
    // 這條件已在 UI 層檢查，但保險起見再 guard 一次
    const safeTopic = topic || (isDE ? 'ein frei wählbares Thema' : 'a topic of your choice');

    return isDE
      ? `Schreibe einen zusammenhängenden Text auf Deutsch (CEFR ${lc}), ${approxLenDE}, zum Thema:
「${safeTopic}」
${commonRuleDE}
- Keine Aufzählungen oder Nummerierungen (außer das Thema impliziert explizit einen Dialog).
- Wenn das Thema einen Dialog nahelegt, verwende "A:" / "B:"-Turns, jeder Turn in einer eigenen Zeile.
- Andernfalls schreibe in gut gegliederten Absätzen.`
      : `Write a coherent piece in CEFR ${lc} English, ${approxLenEN}, on the topic:
“${safeTopic}”
${commonRuleEN}
- No bullet lists or numbering (unless the topic explicitly implies a dialogue).
- If the topic suggests a dialogue, use "A:" / "B:" turns, each turn on its own line.
- Otherwise, write in well-formed paragraphs.`;
  }

  /* === NEW: 18＋（成熟浪漫，非露骨） === */
  if(type === 'mature_18'){
    const topic = (customTopic || '').trim();
    const isDE = (lang === 'de');
    const safe = topic || (isDE ? 'ein reifes, romantisches Thema' : 'a mature, romantic theme');

    return isDE
      ? `Schreibe eine reife, romantische Kurzgeschichte auf Deutsch (CEFR ${lc}), ${approxLenDE}.
Thema: „${safe}“
Rahmenbedingungen:
Schreibe eine explizite erotische Kurzgeschichte, die sich um [spezifizierten erotischen Begriff, z. B. Vaginalverkehr, Analverkehr usw.] dreht. Zufällige Charaktereinstellungen (z. B. Studenten, Fremde, bestimmte Berufe), zufällige Szene (z. B. Wohnheim, Party, öffentlicher Ort), Handlungsentwicklung natürlich, aber schnell in den Höhepunkt eintreten. Fokussiere auf sensorische Details: visuell (Körperteile, Aktionen), auditiv (Keuchen, Stöhnen), taktil (Hautkontakt, Feuchtigkeit), Geschmack/Geruch (Körperflüssigkeiten, Schweiß). Verwende direkte, derbe Sprache, um Geschlechtsorgane und Handlungen zu beschreiben (z. B. Schwanz, Fotze, Stoßen, spritzen), inklusive multipler Orgasmen, Körperreaktionen und psychologischer Konflikte. Ende mit einem Nachhall, der den Leser intensiv befriedigt oder schockiert fühlen lässt. Füge keine moralischen Ermahnungen oder verwässerte Inhalte hinzu, sei direkt explizit.`
      : `Write a mature, romance-driven short story in CEFR ${lc} English (${approxLenEN}).
Theme: “${safe}”
Constraints:
Please write an explicit erotic short story centered around [specified erotic term, e.g., vaginal sex, anal sex, etc.]. Random character settings (e.g., college students, strangers, specific professions), random scene (e.g., dorm, party, public place), plot development natural but quickly entering the climax part. Focus on sensory details: visual (body parts, actions), auditory (panting, moaning), tactile (skin contact, wetness), taste/smell (bodily fluids, sweat). Use direct, crude language to describe sexual organs and actions (e.g., cock, pussy, thrust, cum), include multiple orgasms, body reactions, and psychological conflicts. End with an aftertaste that leaves the reader feeling intensely satisfied or shocked. Do not add moral admonitions or dilute content, be directly explicit.`;
  }


  // fallback（理論上不會走到）
  return isDE
    ? `Schreibe einen gut strukturierten Text (CEFR ${lc}), ${approxLenDE}.\n${commonRuleDE}`
    : `Write a well-structured text in CEFR ${lc} English, ${approxLenEN}.\n${commonRuleEN}`;
}

async function generateContentWithOpenAI({ apiKey, lang, type, words, level, customTopic, targetCount }){
  const provider = getSelectedProvider();
  const model = getSelectedModel();
  // apiKey 參數仍保留，但實際以 UI 選擇為主
  const key = (provider === 'grok')
    ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
    : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

  const lc = (level||'B1').toUpperCase();
  const isDE = (lang === 'de');
  const system = isDE
    ? `Du bist ein hilfreicher Schreibassistent. Schreibe in klarem Deutsch (CEFR ${lc}).`
    : `You are a helpful writing assistant. Write in clear CEFR ${lc} English.`;
  const user = buildUserPromptByType({ lang, type, words, level, customTopic, targetCount });

  const content = await doChat({
    provider, apiKey: key, model,
    messages: [{ role: "system", content: system }, { role: "user", content: user }],
    temperature: 0.9
  });
  return content || '';
}


async function reviseContentToInclude({ apiKey, lang, baseText, missingWords, level, type, targetCount }){
  const provider = getSelectedProvider();
  const model = getSelectedModel();
  const key = (provider === 'grok')
    ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
    : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

  const lc = (level||'B1').toUpperCase();
  const isDE = (lang === 'de');
    const keepLenEN = `Keep the length ~${targetCount || 500} words (±15%).`;
  const keepLenDE = `Halte die Länge bei ca. ${targetCount || 500} Wörtern (±15%).`;
  const listText = missingWords.join(', ');
  const system = isDE
    ? `Du überarbeitest einen ${type}-Text auf Deutsch (CEFR ${lc}).`
    : `You are an assistant revising a ${type} in CEFR ${lc} English.`;
  const user = isDE
    ? `Überarbeite den folgenden deutschen Text so, dass ALLE diese Zielwörter mindestens einmal vorkommen (Groß-/Kleinschreibung egal, Beugungen/Derivate erlaubt): ${listText}
${keepLenDE} Stil beibehalten. Gib NUR den revidierten Text aus, ohne zusätzliche Kommentare.

Text:
${baseText}`
    : `Revise the following text so that it includes ALL of these target words at least once, using either the exact word OR a natural inflected/derived form: ${listText}
${keepLenEN} Keep the style similar. Output the revised text only, no extra commentary.

Text:
${baseText}`;

  const revised = await doChat({
    provider, apiKey: key, model,
    messages: [{ role: "system", content: system }, { role: "user", content: user }],
    temperature: 0.8
  });
  return revised || baseText;
}



/* ========= 選取與解析（保留原有 ①～⑤） ========= */
function selectionWithinReaderStrict(){
  const sel = window.getSelection();
  if(!sel || sel.isCollapsed) return '';
  try{
    const range = sel.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const node = container.nodeType === 1 ? container : container.parentNode;
    if(!reader.contains(node)) return '';
    return sel.toString().trim();
  }catch{ return ''; }
}
function updateBottomBar(){
  if(lastSelectionText){
    bottomBar.style.display = 'flex';
    selStatus.textContent = '按「翻譯與文法」解析選取的內容';
    selPreview.textContent = lastSelectionText.length > 38 ? (lastSelectionText.slice(0,38)+'…') : lastSelectionText;
    doExplainBtn.disabled = false;
  }else{
    bottomBar.style.display = 'none';
    selStatus.textContent = '請先在左側文章中框選句子或片段';
    selPreview.textContent = '未選取';
    doExplainBtn.disabled = true;
  }
}
document.addEventListener('selectionchange', ()=>{
  const txt = selectionWithinReaderStrict();
  lastSelectionText = txt;
  updateBottomBar();
});
$('#analysisClose').addEventListener('click', ()=> analysisCard.style.display='none'); resetAnalysisQ();
doExplainBtn.addEventListener('click', ()=>{
  if(!lastSelectionText){ alert('請先框選句子或片段'); return; }
  explainSelectionWithOpenAI(lastSelectionText);
});

/* === 解析：①～⑤（與你上一版相同的實作，為節省篇幅此處省略注釋） === */
async function explainSelectionWithOpenAI(text){
  resetAnalysisQ();
  const provider = getSelectedProvider();
  const model = getSelectedModel();
  const key = (provider === 'grok')
    ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
    : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

  if(!key){ alert('請先填入對應的 API Key'); return; }
  if(!text){ alert('請先框選句子或片段'); return; }

  analysisCard.style.display = 'block';
  anaSrc.textContent = text;
  anaZh.textContent = '生成中…';
  anaGram.textContent = '生成中…';

  const system = '你是一位專業的英語老師，能以繁體中文詳細解析英文句子。';
  const user = `請針對以下英文句子進行完整的文法與翻譯分析，輸出格式請嚴格遵守：

① 中文翻譯：
（完整、自然的中文意思）

② 文法分析：
主詞（Subject）：
動詞（Verb）：
受詞（Object）：
句型結構：

③ 文法重點與說明：
重點1：（英文片段）→ 中文說明
重點2：（英文片段）→ 中文說明
（如果有更多重點請依序列出）

④ 常見片語：
列出此句中出現的常見片語或固定搭配（若有），每個片語附中文解釋。

⑤ 其他例句：
請依上方文法重點各造一個新的英文例句，不要抄原句，保持語意自然且能體現該文法特點。

英文句子如下：
${text}

請務必使用上述五個標題（①②③④⑤），不要添加其他內容。`;

  try{
    const txt = await doChat({
      provider, apiKey: key, model,
      messages: [{ role: "system", content: system }, { role: "user", content: user }],
      temperature: 0.4
    });

    const zhMatch = txt.match(/①[\s\S]*?中文翻譯[:：]\s*([\s\S]*?)(?=\n②|$)/);
    const gramMatch = txt.match(/②[\s\S]*?文法分析[:：]\s*([\s\S]*?)(?=\n③|$)/);
    const focusMatch = txt.match(/③[\s\S]*?文法重點與說明[:：]\s*([\s\S]*?)(?=\n④|$)/);
    const phraseMatch = txt.match(/④[\s\S]*?常見片語[:：]\s*([\s\S]*?)(?=\n⑤|$)/);
    const exMatch = txt.match(/⑤[\s\S]*?其他例句[:：]\s*([\s\S]*)/);

    anaZh.textContent = zhMatch ? zhMatch[1].trim() : '（未取得翻譯）';
    let html = '';
    if(gramMatch){ html += `<div class="sec"><h4>② 文法分析</h4><pre class="zh">${gramMatch[1].trim()}</pre></div>`; }
    if(focusMatch){
      const lines = focusMatch[1].split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const lis = lines.map((line)=>{
        const m = line.match(/重點\d+：\s*（(.+?)）\s*→\s*(.+)$/);
        const en = m ? m[1].trim() : line.replace(/^重點\d+[:：]\s*/,'');
        const zh = m ? m[2].trim() : '';
        return `<li><strong>${en}</strong> — ${zh}</li>`;
      }).join('');
      html += `<div class="sec"><h4>③ 文法重點與說明</h4><ul>${lis}</ul></div>`;
    }
    if(phraseMatch){
      const lines = phraseMatch[1].split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const lis = lines.map((line,i)=>{
        let ph = line, ex = '';
        const mm = line.match(/^(.*?)\s*(—|–|-|：|:)\s*(.*)$/);
        if(mm){ ph = (mm[1]||'').trim(); ex = (mm[3]||'').trim(); }
        return `<li data-phrase="${ph.replace(/"/g,'&quot;')}" data-explain="${ex.replace(/"/g,'&quot;')}"><strong>${ph}</strong>${ex?` — ${ex}`:''}
          <button class="secondary more-ex-btn" data-kind="phrase" data-index="${i}">其他例句</button>
          <ul class="more-ex-list" style="margin-top:6px;padding-left:18px"></ul></li>`;
      }).join('');
      html += `<div class="sec"><h4>④ 常見片語</h4><ul>${lis}</ul></div>`;
    }
    if(exMatch){ html += `<div class="sec examples"><h4>⑤ 其他例句</h4><pre class="zh">${(exMatch[1]||'').trim()}</pre></div>`; }
    anaGram.innerHTML = html || '<div class="help">（未解析到文法資訊）</div>';
    anaGram.dataset.original = text;
  }catch(err){
    anaZh.textContent = '產生失敗：' + err.message;
    anaGram.textContent = '';
  }
}


/* ========= 生成內容 UI ========= */
function bindStoryUI(){
  const keyInput   = $('#openaiKey');  // OpenAI
  const grokInput  = $('#grokKey');    // Grok
  const saveBtn    = $('#saveKey');
  const genBtn     = $('#genContent');
  const levelSel   = $('#levelSelect');
  const genreSel   = $('#genreSelect');
  const topicInput = $('#customTopic');

  const providerSel = $('#providerSelect');
  const modelSel    = $('#modelSelect');
  const modelCustom = $('#modelCustom');

  // 載入金鑰
  keyInput.value  = loadOpenAIKey();
  grokInput.value = loadGrokKey();

  // Provider -> 預設模型清單
  const MODEL_OPTIONS = {
  openai: [
    'gpt-4o-mini',
    'gpt-4o',
    'gpt-4.1-mini'
  ],
  grok: [
    'grok-4',        // 最新通用（若報「model not found」，改填精確版號或用下方 fast）
    'grok-4-fast',   // 速度優先版本
    'grok-2.5',      // 2025 Q2 系列（相容性備援）
    'grok-2-latest',
    'grok-2-mini'
  ]
};

  function refillModelOptions(){
    const p = providerSel.value || 'openai';
    const opts = MODEL_OPTIONS[p] || [];
    modelSel.innerHTML = opts.map(x=>`<option value="${x}">${x}</option>`).join('');
  }
  refillModelOptions();

  // Provider 切換時：顯示對應金鑰、刷新模型清單
  function reflectProviderUI(){
    const p = providerSel.value || 'openai';
    if(p === 'grok'){
      grokInput.style.display = '';
      keyInput.style.display  = '';      // 仍保留顯示，因為 TTS 還需要 OpenAI 金鑰
    }else{
      grokInput.style.display = 'none';
      keyInput.style.display  = '';      // OpenAI 金鑰常駐（生成與 TTS 皆可用）
    }
    refillModelOptions();
  }
  providerSel.addEventListener('change', reflectProviderUI);
  reflectProviderUI();

  // 類型變更：顯示/隱藏「自訂主題」
  const toggleTopic = ()=>{
  const t = genreSel.value;
  if(t === 'custom' || t === 'mature_18'){ topicInput && (topicInput.style.display = ''); }
  else{
    if(topicInput){ topicInput.style.display = 'none'; topicInput.value = ''; }
  }
};
;
  genreSel.addEventListener('change', toggleTopic);
  toggleTopic();

  // 儲存金鑰（OpenAI + Grok）
  saveBtn.addEventListener('click', ()=>{
    saveOpenAIKey(keyInput.value);
    saveGrokKey(grokInput.value);
    alert('已儲存到本機（localStorage）');
  });

  // 生成內容
  genBtn.addEventListener('click', async ()=>{
    try{
      genBtn.disabled = true; genBtn.textContent = '生成中…';

      const provider = getSelectedProvider();
      const usingKey = (provider === 'grok')
        ? (grokInput.value.trim() || loadGrokKey())
        : (keyInput.value.trim()  || loadOpenAIKey());

      if(!usingKey){ alert('請先填入對應的 API Key'); return; }

      const lang  = getLang();
      const level = (levelSel.value || 'B1').toUpperCase();
      const type  = genreSel.value;
      const customTopic = (topicInput?.value || '').trim();
      const targetCount = getTargetLen();


if((type === 'custom' || type === 'mature_18') && !customTopic){
  alert('請輸入主題。');
  return;
}


      let words = getTopNWordsLocal(15);
      if(words.length === 0){
        const text = await generateContentWithOpenAI({ apiKey: usingKey, lang, type, words: [], level, customTopic, targetCount });
        $('#src').value = text; compile();
        alert('已生成隨機內容（目前生字本沒有單字）。');
        return;
      }

        let text = await generateContentWithOpenAI({ apiKey: usingKey, lang, type, words, level, customTopic, targetCount });
      let missing = wordsMissingFrom(text, words);
      if(missing.length){
        text = await reviseContentToInclude({ apiKey: usingKey, lang, baseText: text, missingWords: missing, level, type, targetCount });
        missing = wordsMissingFrom(text, words);
        if(missing.length){ alert('注意：仍未成功納入：\n' + missing.join(', ')); }
      }

      $('#src').value = text; compile();
      alert(type === 'custom'
        ? '已依自訂主題生成內容，並盡力納入前 15 個高頻單字（允許詞形變化/派生）。'
        : '已生成內容並盡力納入前 15 個高頻單字（允許詞形變化/派生）。');

    }catch(err){
      console.error(err); alert('發生錯誤：' + err.message);
    }finally{
      genBtn.disabled = false; genBtn.textContent = '生成內容';
    }
  });
}


/* ========= TTS：生成與播放 ========= */
function getApiKey(){ return ($('#openaiKey').value.trim() || loadOpenAIKey()); }
function resetAllPlayButtons(){
  $$('.playseg').forEach(btn=>{
    btn.classList.remove('playing');
    btn.textContent = '▶';
    btn.title = (btn.title || '').replace('（播放中）','').trim();});}
function setButtonPlaying(btn, isPlaying){
  if(isPlaying){
    btn.classList.add('playing');
    btn.textContent = '■';                 // 停止圖示
    if(!/播放中/.test(btn.title)) btn.title = (btn.title || '') + '（播放中）';
  }else{
    btn.classList.remove('playing');
    btn.textContent = '▶';
    btn.title = (btn.title || '').replace('（播放中）','').trim();}}

/* 呼叫 OpenAI TTS，回傳 blob URL */
async function fetchTTSUrl({ text, voice }){
  const apiKey = getApiKey();
  if(!apiKey) throw new Error('請先填入 OpenAI API Key');
  const resp = await fetch('https://api.openai.com/v1/audio/speech', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: 'gpt-4o-mini-tts', voice: voice || VOICE_MALE, input: text })
  });
  if(!resp.ok){ throw new Error('TTS 失敗：' + (await resp.text().catch(()=>resp.status))); }
  const arrayBuf = await resp.arrayBuffer();
  const blob = new Blob([arrayBuf], { type: 'audio/mpeg' });
  return URL.createObjectURL(blob);
}

async function buildTTSForCurrent() {
  const segEls = $$('.reader .seg');
  if (!segEls.length) {
    alert('沒有可朗讀的文字');
    return;
  }

  // 清空舊音訊
  for (const [, v] of segAudios) { try { if (v.url) URL.revokeObjectURL(v.url); } catch {} }
  segAudios.clear();

  // 讀取類型：只有 dialogue 才交替；童話 / 專業文章用單一聲
  const genre = getSelectedGenre();                // 'fairy_tale' | 'dialogue' | 'article'
  const shouldAlternate = (genre === 'dialogue');

  // 使用者偏好
  const pref = ($('#voicePref').value || 'male');  // 'male' or 'female'
  const startMale = (pref !== 'female');           // 選男→男；選女→女
  const uniformVoice = startMale ? VOICE_MALE : VOICE_FEMALE;

  // 交替用的計數器（只在 dialogue 時會用到）
  let spokenIndex = 0;
  const getVoiceByTurn = (turn) => {
    const maleThis = startMale ? (turn % 2 === 0) : (turn % 2 === 1);
    return maleThis ? VOICE_MALE : VOICE_FEMALE;
  };

  // 逐段處理（.seg 已去掉空白行）
  for (const segEl of segEls) {
  const raw = segEl.textContent.trim();
  const cleaned = sanitizeSegmentForTTS(raw, genre);
  if (!cleaned) continue; // 清完變空就跳過

  const i = parseInt(segEl.dataset.i, 10);
  const voice = shouldAlternate ? getVoiceByTurn(spokenIndex) : uniformVoice;

  try {
    const url = await fetchTTSUrl({ text: cleaned, voice });
    segAudios.set(i, { url, voice });

    if (!segEl.querySelector('.playseg')) {
      const btn = document.createElement('button');
      btn.className = 'playseg';
      btn.textContent = '▶';
      btn.title = `播放這段（${voice === VOICE_MALE ? '男' : '女'}聲）`;
      btn.dataset.i = String(i);
      segEl.prepend(btn);
    }

    if (shouldAlternate) spokenIndex++;
  } catch (err) {
    console.error('TTS 失敗 at line', i, err);
  }
}

  ttsGenerated = true;
  clearAllSegHighlights(); 
  ttsDrawer.classList.add('show');
  alert(shouldAlternate
    ? '語音已生成（對話：男女交替）。'
    : '語音已生成（整篇單一聲線）。');
}



/* 點擊段落喇叭 */
function segPlayHandler(e){
  const btn = e.target.closest('.playseg');
  if(!btn) return;
  if(!ttsGenerated){ alert('請先按「生成語音」'); return; }

  const idx = parseInt(btn.dataset.i, 10);
  const item = segAudios.get(idx);
  if(!item) return;

  // 若同一顆正在播，則變成停止
  if(btn.classList.contains('playing')){
    playQueue = [];
    if(currentAudio){ try{ currentAudio.pause(); }catch{} currentAudio = null; }
    setButtonPlaying(btn, false);
    clearAllSegHighlights();
    return;
  }

  // 播放這一段之前，先把其它都復位
  resetAllPlayButtons();
  clearAllSegHighlights();
  playQueue = [];
  if(currentAudio){ try{ currentAudio.pause(); }catch{} currentAudio = null; }

  const rate = parseFloat(rateRange.value) || 1;
  const au = new Audio(item.url);
  au.playbackRate = rate;
  currentAudio = au;

  setButtonPlaying(btn, true);
  highlightSegmentByIndex(idx);

  au.onended = ()=>{
    setButtonPlaying(btn, false);
    clearAllSegHighlights();
    currentAudio = null;
  };

  au.play().catch(err=>{
    console.error(err);
    setButtonPlaying(btn, false);
    clearAllSegHighlights(); 
    currentAudio = null;
  });
}

/* 播放全部（按段落順序；聲音已交替好） */
async function ttsPlaySegmentsAll() {
  if (!ttsGenerated) { alert('請先按「生成語音」'); return; }

  if (currentAudio) { try { currentAudio.pause(); } catch {} currentAudio = null; }
  playQueue = [];

  const rate = parseFloat($('#rateRange').value) || 1;
  const orderedIdx = Array.from(segAudios.keys()).sort((a,b)=> a - b);
for (const i of orderedIdx) {
  const item = segAudios.get(i);
  if (item) playQueue.push({ idx: i, url: item.url, voice: item.voice }); 
}

  const playNext = function() {
  if (playQueue.length === 0) { currentAudio = null; clearAllSegHighlights(); return; }
  const it = playQueue.shift();

  clearAllSegHighlights();               // ✅ 換段前清空
  highlightSegmentByIndex(it.idx);       // ✅ 高亮當前段

  const au = new Audio(it.url);
  au.playbackRate = rate;
  currentAudio = au;
  au.onended = playNext;
  au.play().catch(err => {
    console.error(err);
    playNext();                          // 失敗時繼續下一段，會自動換高亮
  });
};
  playNext();
}


/* TTS 控制 UI 綁定 */
function bindTTSUI(){
  rateRange.addEventListener('input', ()=>{
    rateLabel.textContent = `${parseFloat(rateRange.value).toFixed(2)}×`;
    if(currentAudio){ currentAudio.playbackRate = parseFloat(rateRange.value); }
  });
  $('#ttsPlayAll').addEventListener('click', ttsPlaySegmentsAll);
  $('#ttsStop').addEventListener('click', ()=>{
  playQueue = [];
  if(currentAudio){ currentAudio.pause(); currentAudio=null; }
  clearAllSegHighlights();                 // ✅ 按停止清空高亮
});
  $('#buildTTS').addEventListener('click', async ()=>{
    const key = getApiKey();
    if(!key){ alert('請先填入 OpenAI API Key'); return; }
    const btn = $('#buildTTS');
    try{
      btn.disabled = true; btn.textContent = '生成語音中…';
      await buildTTSForCurrent();
    }catch(err){
      alert('生成語音失敗：' + err.message);
    }finally{
      btn.disabled = false; btn.textContent = '生成語音';
    }
  });
}

/* ========= 一般綁定 ========= */
function bindGeneralUI(){
  $('#compile').addEventListener('click', compile);
  $('#sample').addEventListener('click', ()=>{
    $('#src').value = `A: Hey, do you want to grab coffee after class?
B: Sure! I was thinking about that new place near the library.
A: The one with the cozy lights and the giant muffins?
B: Exactly. Their muffins are legendary.
A: Let's meet there at five, then.
B: Deal! See you at five.\n
In the heart of the city, curiosity sparks when we notice subtle patterns in everyday life.
Language evolves; words adapt, meanings shift, and our interpretations blossom.`;
    compile();
  });
  $('#clearAll').addEventListener('click', ()=>{
    $('#src').value=''; reader.innerHTML='<div class="empty">已清空，請貼上新文章。</div>';
    // 清掉語音 UI
    for(const [,v] of segAudios){ try{ URL.revokeObjectURL(v.url); }catch{} }
    segAudios.clear(); ttsGenerated=false; ttsDrawer.classList.remove('show');
  });

  $('#cardClose').addEventListener('click', ()=> card.style.display='none'); resetWordQ(); 

  $('#exportCSV').addEventListener('click', exportCSV);
  $('#exportJSON').addEventListener('click', exportJSON);
  $('#importJSON').addEventListener('change', e=>{
    const f = e.target.files?.[0];
    if(f) importJSONFile(f);
    e.target.value = '';
  });

    // ★ 新增：匯入 CSV 綁定
  const importCSVInput = document.getElementById('importCSV');
  if(importCSVInput){
    importCSVInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(f) importCSVFile(f);
      e.target.value = '';
    });
  }


  $('#resetWords').addEventListener('click', ()=>{
    if(confirm('確定要清空生字本？此動作無法復原。')){
      saveWords([]); renderWordList(); applyHFClassesToReader();
      $$('.reader .word').forEach(el=> el.classList.remove('deducted'));
    }
  });
  $('#q').addEventListener('input', renderWordList);
  $('#qClear').addEventListener('click', ()=>{ $('#q').value=''; renderWordList(); });
  document.getElementById('langSelect')?.addEventListener('change', ()=>{
  updateUILang(); 
  renderWordList();
  applyHFClassesToReader();
  });
    // ===== 字典開關按鈕 =====
  const dictBtn = document.getElementById('toggleDict');
  if(dictBtn){
    updateDictToggleUI(); // 進頁就刷新一次顯示
    dictBtn.addEventListener('click', ()=>{
      setDictOff(!isDictOff());
      updateDictToggleUI();
    });
  }

}

function bindExtraQuestionUI(){
  const btn = document.getElementById('extraQBtn');
  if(!btn) return;

  btn.addEventListener('click', async ()=>{
    const sel = (document.getElementById('anaSrc').textContent || '').trim();
    const q = document.getElementById('extraQInput').value.trim();
    if(!sel || !q) return;

    const provider = getSelectedProvider();
    const model = getSelectedModel();
    const key = (provider === 'grok')
      ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
      : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

    document.getElementById('extraQAns').textContent = '生成中...';

    try{
      const ans = await doChat({
        provider, apiKey: key, model,
        messages: [
          {role:'system',content:'你是英語語法與語意分析專家，請只針對該句子作答，並用繁體中文。'},
          {role:'user',content:`句子：${sel}\n問題：${q}`}
        ],
        temperature: 0.3
      });
      document.getElementById('extraQAns').innerHTML = ans || '（無回應）';
      document.getElementById('extraQInput').value = '';
    }catch(err){
      document.getElementById('extraQAns').textContent = '（生成失敗）';
    }
  });
}



function bindWordCardQA(){
  const btn = document.getElementById('wordQBtn');
  const input = document.getElementById('wordQInput');
  if(!btn || !input) return;

  btn.addEventListener('click', async ()=>{
    const q = (input.value || '').trim();
    if(!q) return;

    const provider = getSelectedProvider();
    const model = getSelectedModel();
    const key = (provider === 'grok')
      ? (document.getElementById('grokKey').value.trim() || loadGrokKey())
      : (document.getElementById('openaiKey').value.trim() || loadOpenAIKey());

    if(!key){ alert('請先輸入對應的 API Key'); return; }

    const titleText = (document.getElementById('cardTitle').textContent || '').trim();
    const word = titleText.replace(/^查詢\s*/,'').trim();

    document.getElementById('qaBox').textContent = '回答生成中...';

    try{
      const ans = await doChat({
        provider, apiKey: key, model,
        messages: [
          {role:'system',content:'你是一位英德雙語字典專家，只能針對該單字回答，請用繁體中文簡潔作答。'},
          {role:'user',content:`單字：${word}\n問題：${q}`}
        ]
      });
      document.getElementById('qaBox').innerHTML = ans || '（無回應）';
      document.getElementById('wordQInput').value = '';
    }catch(err){
      document.getElementById('qaBox').textContent = '（生成失敗）';
    }
  });
}


/* ========= 初始化 ========= */
function init(){
  updateUILang(); 
  renderWordList();
  flushQueue();
  bindStoryUI();
  bindTTSUI();
  bindGeneralUI();
  bindWordCardQA();
  bindExtraQuestionUI(); 
  updateBottomBar();
}
init();
</script>
</body>
</html>
